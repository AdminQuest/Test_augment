<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin'Quest - Pr√©parateur intelligent aux oraux d'administrateur territorial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f8f9fa;
        }
        
        /* STYLES POUR L'√âCRAN DE V√âRIFICATION D'ABONNEMENT */
        .subscription-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .subscription-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .subscription-container h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subscription-container .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .subscription-form {
            margin-bottom: 30px;
        }
        
        .subscription-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            transition: border-color 0.3s;
        }
        
        .subscription-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .subscription-form button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 5px;
        }
        
        .subscription-form button:hover {
            transform: translateY(-2px);
        }
        
        .test-buttons {
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .test-buttons p {
            color: #666;
            margin-bottom: 10px;
        }
        
        .test-buttons button {
            background: #27ae60;
            margin: 2px;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
            display: inline-block;
        }
        
        .test-buttons .debug-btn {
            background: #e67e22;
        }
        
        .test-buttons .fabrice-btn {
            background: #3498db;
        }
        
        .github-status {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #e74c3c;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            background: #e8f5e9;
            border: 1px solid #43a047;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        /* STYLES POUR L'APPLICATION PRINCIPALE (cach√©e par d√©faut) */
        .main-app {
            display: none;
        }

        /* INTERFACE ADMINISTRATEUR - STYLES */
        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .admin-modal {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            color: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            text-align: center;
        }

        .admin-modal h2 {
            margin: 0 0 1.5rem 0;
            color: #3498db;
            font-size: 1.8rem;
        }

        .admin-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
        }

        .admin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }

        .admin-button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .admin-button.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .admin-status {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .admin-progress {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .admin-progress-bar {
            background: #3498db;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-left: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bouton de d√©connexion dans l'app */
        .logout-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
        }

        /* Notification syst√®me */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 999999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        
        h3 {
            color: #2980b9;
            margin-top: 20px;
        }
        
        .controls {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            z-index: 0;
        }

        .controls:hover {
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.12);
            border-color: #d6eaf8;
        }
        
        .controls .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .controls label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        select, input[type="text"] {
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            width: 100%;
            font-size: 1em;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: #ffffff;
            transform: translateY(-1px);
        }

        select:hover, input[type="text"]:hover {
            border-color: #bdc3c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233498db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        input[type="text"]::placeholder {
            color: #95a5a6;
            font-style: italic;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .question-container {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            transition: background-color 0.3s;
        }
        
        .question-container:hover {
            background-color: #e8f4f8;
        }
        
        .question {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metadata {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .attention-points {
            margin-top: 10px;
            font-style: italic;
        }
        
        .keywords {
            margin-top: 5px;
        }
        
        .keyword {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            display: inline-block;
        }
        
        .hidden {
            display: none;
        }
        
        #searchResults {
            margin-top: 20px;
        }
        
        #questionsCount {
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .buttons-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-reset {
            background-color: #6c757d;
        }
        
        .difficulty-1 {
            border-left-color: #2ecc71;
        }
        
        .difficulty-2 {
            border-left-color: #3498db;
        }
        
        .difficulty-3 {
            border-left-color: #f39c12;
        }
        
        .difficulty-4 {
            border-left-color: #e74c3c;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #ecf0f1;
        }

        .auto-response {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            padding-left: 60px;
        }

        .auto-response h4 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .auto-response .response-icon {
            position: absolute;
            left: 15px;
            top: 15px;
            font-size: 28px;
        }

        .auto-response p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .auto-response p strong {
            display: inline-block;
            min-width: 160px;
        }

        .auto-response.rafale {
            background-color: #e8f5e9;
            border-left: 5px solid #43a047;
        }
        .auto-response.rafale h4 {
            color: #2e7d32;
        }
        .auto-response.rafale .response-icon {
            color: #2e7d32;
        }

        .auto-response.enjeux {
            background-color: #e3f2fd;
            border-left: 5px solid #1976d2;
        }
        .auto-response.enjeux h4 {
            color: #0d47a1;
        }
        .auto-response.enjeux .response-icon {
            color: #0d47a1;
        }

        .auto-response.poisson {
            background-color: #fff8e1;
            border-left: 5px solid #ffa000;
        }
        .auto-response.poisson h4 {
            color: #e65100;
        }
        .auto-response.poisson .response-icon {
            color: #e65100;
        }

        .auto-response.reflexive {
            background-color: #f3e5f5;
            border-left: 5px solid #8e24aa;
        }
        .auto-response.reflexive h4 {
            color: #4a148c;
        }
        .auto-response.reflexive .response-icon {
            color: #4a148c;
        }

        .auto-response.theatre {
            background-color: #ffebee;
            border-left: 5px solid #e53935;
        }
        .auto-response.theatre h4 {
            color: #b71c1c;
        }
        .auto-response.theatre .response-icon {
            color: #b71c1c;
        }

        .auto-response.technique-longue {
            background-color: #fff3e0;
            border-left: 5px solid #ff6600;
        }
        .auto-response.technique-longue h4 {
            color: #e65100;
        }
        .auto-response.technique-longue .response-icon {
            color: #e65100;
        }

        .auto-response.technique-courte {
            background-color: #f1f8e9;
            border-left: 5px solid #8bc34a;
        }
        .auto-response.technique-courte h4 {
            color: #33691e;
        }
        .auto-response.technique-courte .response-icon {
            color: #33691e;
        }

        .response-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #ecf0f1 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            min-height: 70px;
        }

        .response-controls:hover {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.15);
            border-color: #3498db;
            z-index: 2;
            margin-bottom: 42px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            justify-content: space-between;
        }

        .toggle-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
            margin: 0;
            user-select: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .auto-toggle-switch {
            position: relative;
            width: 70px;
            height: 34px;
            background-color: #bdc3c7;
            border-radius: 34px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #95a5a6;
        }

        .auto-toggle-switch:hover {
            transform: translateY(-1px);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1), 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .auto-toggle-switch.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-color: #2980b9;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1), 0 0 20px rgba(52, 152, 219, 0.4);
        }

        .auto-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auto-toggle-slider::before {
            content: '';
            width: 16px;
            height: 16px;
            background: #bdc3c7;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .auto-toggle-switch.active .auto-toggle-slider {
            transform: translateX(36px);
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3), 0 2px 6px rgba(0,0,0,0.1);
        }

        .auto-toggle-switch.active .auto-toggle-slider::before {
            background: #3498db;
            width: 18px;
            height: 18px;
        }

        .auto-toggle-status {
            font-size: 0.95em;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

        .auto-toggle-status.active {
            color: #2980b9;
        }

        #showAutoResponses {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .auto-toggle-switch.pulse {
            animation: pulse 0.3s ease-in-out;
        }

        .header-container {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo {
            height: 400px;
            margin-right: 15px;
        }
        
        .subtitle {
            color: #3498db;
            margin: 15px 0;
            font-size: 1.5em;
            font-weight: normal;
        }

        .author {
            font-size: 1em;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-status.online {
            background: rgba(46, 125, 50, 0.9);
        }

        .sync-status.updating {
            background: rgba(255, 152, 0, 0.9);
        }

        .sync-status.offline {
            background: rgba(211, 47, 47, 0.9);
        }

        @media (max-width: 768px) {
            .subscription-container {
                padding: 20px;
                margin: 10px;
            }
            
            .response-controls {
                flex-direction: column;
                gap: 20px;
                text-align: center;
                margin-bottom: 35px;
                padding: 20px;
            }
            
            .toggle-container {
                flex-direction: column;
                gap: 15px;
                justify-content: center;
            }
            
            .toggle-label {
                margin: 0;
                text-align: center;
                font-size: 1em;
            }

            .toggle-switch-container {
                gap: 10px;
            }

            .controls {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
                margin: 20px 0;
            }

            .controls label {
                font-size: 0.9em;
            }

            select, input[type="text"] {
                padding: 10px 12px;
                font-size: 0.95em;
            }

            select {
                padding-right: 35px;
                background-size: 14px;
                background-position: right 10px center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- √âCRAN DE V√âRIFICATION D'ABONNEMENT -->
    <div id="subscriptionOverlay" class="subscription-overlay">
        <div class="subscription-container">
            <h2>üéì Admin'Quest</h2>
            <p class="subtitle">Pr√©parateur intelligent aux oraux d'administrateur territorial</p>
            
            <div id="subscriptionForm" class="subscription-form">
                <h3>Acc√®s par code d'abonnement</h3>
                <input type="text" id="subscriptionCode" placeholder="Entrez votre code d'acc√®s" maxlength="20">
                <button onclick="validateSubscription()">Valider l'acc√®s</button>
                
                <div class="test-buttons">
                    <p>üß™ <strong>Codes de test :</strong></p>
                    <button onclick="testDemo()">Test DEMO2025</button>
                    <button onclick="testFabrice()" class="fabrice-btn">Test FABRICE2025</button>
                    <button onclick="testI90UB9F2()" style="background: #9b59b6;">Test I90UB9F2</button>
                </div>
                
                <div class="github-status">
                    üåê <strong>Architecture centralis√©e :</strong> Import administrateur avec synchronisation automatique
                    <br><small>Donn√©es partag√©es instantan√©ment entre tous les utilisateurs</small>
                </div>
                
                <div id="subscriptionError" class="error-message"></div>
                <div id="subscriptionSuccess" class="success-message"></div>
            </div>
        </div>
    </div>

    <!-- √âCRAN DE CHARGEMENT -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Chargement en cours...</h3>
            <p id="loadingStatus">Synchronisation avec le serveur...</p>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="mainApp" class="main-app">
        <div class="header-container">
            <div class="logo-container">
                <img src="https://i.goopics.net/0opqy7.png" alt="Logo Admin'Quest" class="logo">
            </div>
            <h2 class="subtitle">Pr√©parateur intelligent aux oraux d'administrateur territorial</h2>
            <p class="author">par Fabrice RIBET, pr√©parateur aux concours du CNFPT, administrateur territorial, magistrat financier</p>
            
            <div class="logout-container">
                <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
            </div>
        </div>

        <!-- Bouton admin discret -->
        <div style="position: fixed; bottom: 80px; right: 20px; z-index: 1000;">
            <button onclick="openAdminPanel()" style="
                background: rgba(52, 73, 94, 0.8); 
                border: none; 
                border-radius: 50%; 
                width: 50px; 
                height: 50px; 
                color: white; 
                cursor: pointer; 
                font-size: 18px;
                opacity: 0.3;
                transition: opacity 0.3s;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            " 
            onmouseover="this.style.opacity='1'" 
            onmouseout="this.style.opacity='0.3'"
            title="Interface administrateur (Ctrl+Alt+A)">‚öôÔ∏è</button>
        </div>

        <!-- Statut de synchronisation -->
        <div id="syncStatus" class="sync-status online">
            <i class="fas fa-wifi"></i>
            <span>Synchronis√©</span>
        </div>

        <div class="response-controls">
            <div class="toggle-container">
                <label class="toggle-label" for="showAutoResponses">
                    <i class="fas fa-magic"></i>
                    Afficher les r√©ponses automatiques
                </label>
                <div class="toggle-switch-container">
                    <div class="auto-toggle-switch" id="autoToggleSwitch">
                        <div class="auto-toggle-slider"></div>
                    </div>
                    <span class="auto-toggle-status" id="autoToggleStatus">Masqu√©es</span>
                </div>
            </div>
            <input type="checkbox" id="showAutoResponses">
        </div>
            
        <div class="controls">
            <div class="control-group">
                <label for="categoryFilter">Cat√©gorie</label>
                <select id="categoryFilter">
                    <option value="all">Toutes les cat√©gories</option>
                    <option value="1">1. Questions de personnalit√©</option>
                    <option value="2">2. Questions manag√©riales</option>
                    <option value="3">3. Questions de culture territoriale</option>
                    <option value="4">4. Mises en situation</option>
                    <option value="5">5. Questions embarrassantes</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="subcategoryFilter">Sous-cat√©gorie</label>
                <select id="subcategoryFilter">
                    <option value="all">Toutes les sous-cat√©gories</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="difficultyFilter">Difficult√©</label>
                <select id="difficultyFilter">
                    <option value="all">Tous niveaux</option>
                    <option value="1">Niveau 1 - Connaissances fondamentales</option>
                    <option value="2">Niveau 2 - Analyse simple</option>
                    <option value="3">Niveau 3 - Analyse approfondie</option>
                    <option value="4">Niveau 4 - Questions pi√®ges</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="searchInput">Recherche</label>
                <input type="text" id="searchInput" placeholder="Entrez un mot-cl√©...">
            </div>
        </div>
        
        <div class="buttons-row">
            <button id="randomButton">Question al√©atoire</button>
            <button id="resetButton" class="btn-reset">R√©initialiser filtres</button>
        </div>
        
        <div id="questionsCount"></div>
        <div id="questionList"></div>
        
        <footer>
            <p>¬© Fabrice Ribet 2025 - Tous droits r√©serv√©s - Reproduction interdite</p>
            <p><small>üåê Architecture centralis√©e - Synchronisation automatique</small></p>
        </footer>
    </div>
    
    <!-- INTERFACE ADMINISTRATEUR -->
    <div id="adminOverlay" class="admin-overlay">
        <div class="admin-modal">
            <h2>üîê Interface Administrateur</h2>
            <p>Gestion centralis√©e de la base de donn√©es</p>
            
            <div class="admin-status">
                <div><strong>Base actuelle :</strong> <span id="adminCurrentBase">En cours de v√©rification...</span></div>
                <div><strong>Derni√®re MAJ :</strong> <span id="adminLastUpdate">-</span></div>
                <div><strong>Nombre de questions :</strong> <span id="adminQuestionCount">-</span></div>
            </div>

            <button class="admin-button" onclick="importCSVAdmin()">
                <i class="fas fa-upload"></i> Import nouveau CSV
            </button>
            
            <button class="admin-button success" onclick="syncAllUsers()">
                <i class="fas fa-sync"></i> Synchroniser tous les utilisateurs
            </button>
            
            <button class="admin-button" onclick="testNotification()">
                <i class="fas fa-bell"></i> Test notification globale
            </button>
            
            <div id="adminProgress" class="admin-progress" style="display: none;">
                <div class="admin-progress-bar"></div>
            </div>
            
            <div id="adminStatus" style="margin: 10px 0; font-size: 0.9em;"></div>
            
            <button class="admin-button danger" onclick="closeAdminPanel()">
                <i class="fas fa-times"></i> Fermer
            </button>
        </div>
    </div>
    
    <!-- Syst√®me de notifications -->
    <div id="notification" class="notification"></div>
    
    <script>
        console.log("üîç Admin'Quest - Architecture centralis√©e avec import administrateur");
        
        // ===============================
        // SYST√àME DE GESTION D'ABONNEMENT
        // ===============================
        
        function getSubscriptionsDatabase() {
            return {
                'DEMO2025': {
                    startDate: '2025-01-01',
                    endDate: '2025-12-31',
                    email: 'demo@example.com',
                    type: 'demo'
                },
                'FABRICE2025': {
                    startDate: '2025-01-01',
                    endDate: '2025-12-31',
                    email: 'fabrice.ribet@gmail.com',
                    type: 'admin'
                },
                'I90UB9F2': {
                    startDate: '2025-11-29',
                    endDate: '2026-11-29',
                    email: 'copeau@gmail.com',
                    type: 'standard'
                }
            };
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('subscriptionError');
            const successDiv = document.getElementById('subscriptionSuccess');
            
            if (errorDiv && successDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
        }
        
        function showSuccess(message) {
            const errorDiv = document.getElementById('subscriptionError');
            const successDiv = document.getElementById('subscriptionSuccess');
            
            if (errorDiv && successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }
        }
        
        function validateSubscription() {
            const codeInput = document.getElementById('subscriptionCode');
            if (!codeInput) return;
            
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showError('Veuillez entrer un code d\'acc√®s');
                return;
            }
            
            const subscriptions = getSubscriptionsDatabase();
            const subscription = subscriptions[code];
            
            if (!subscription) {
                showError('Code d\'acc√®s invalide. Codes de test : DEMO2025, FABRICE2025, I90UB9F2');
                return;
            }
            
            const now = new Date();
            const endDate = new Date(subscription.endDate);
            
            if (endDate < now) {
                showError('Cet abonnement a expir√© le ' + endDate.toLocaleDateString('fr-FR'));
                return;
            }
            
            const subscriptionData = {
                code: code,
                startDate: subscription.startDate,
                endDate: subscription.endDate,
                email: subscription.email || '',
                type: subscription.type || 'standard',
                validatedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('adminquest_subscription', JSON.stringify(subscriptionData));
            } catch(e) {
                showError('Erreur de sauvegarde. Essayez un autre navigateur.');
                return;
            }
            
            showSuccess(`Acc√®s valid√© ! Abonnement valide jusqu'au ${endDate.toLocaleDateString('fr-FR')}`);
            setTimeout(() => {
                document.getElementById('subscriptionOverlay').style.display = 'none';
                showLoadingAndInitApp();
            }, 1500);
        }
        
        function logout() {
            localStorage.removeItem('adminquest_subscription');
            location.reload();
        }
        
        function getValidSubscription() {
            try {
                const stored = localStorage.getItem('adminquest_subscription');
                if (!stored) return null;
                
                const subscription = JSON.parse(stored);
                const endDate = new Date(subscription.endDate);
                const now = new Date();
                
                if (endDate > now) {
                    return subscription;
                } else {
                    localStorage.removeItem('adminquest_subscription');
                    return null;
                }
            } catch (e) {
                localStorage.removeItem('adminquest_subscription');
                return null;
            }
        }
        
        function testDemo() {
            document.getElementById('subscriptionCode').value = 'DEMO2025';
            validateSubscription();
        }
        
        function testFabrice() {
            document.getElementById('subscriptionCode').value = 'FABRICE2025';
            validateSubscription();
        }
        
        function testI90UB9F2() {
            document.getElementById('subscriptionCode').value = 'I90UB9F2';
            validateSubscription();
        }

        // ===============================
        // SYST√àME DE SYNCHRONISATION CENTRALIS√â
        // ===============================
        
        let isAdmin = false;
        let lastDataVersion = null;
        let syncInterval = null;
        
        // Simulateur d'API serveur (√† remplacer par votre vraie API)
        class ServerAPI {
            constructor() {
                this.baseUrl = '/api'; // Remplacer par votre URL d'API
                this.currentVersion = this.getStoredVersion();
            }
            
            getStoredVersion() {
                return localStorage.getItem('adminquest_data_version') || '1.0.0';
            }
            
            setStoredVersion(version) {
                localStorage.setItem('adminquest_data_version', version);
                this.currentVersion = version;
            }
            
            // Simuler un appel API pour obtenir la version des donn√©es
            async getDataVersion() {
                try {
                    // EN PRODUCTION : remplacer par un vrai appel API
                    // const response = await fetch(`${this.baseUrl}/version`);
                    // return await response.json();
                    
                    // SIMULATION pour la d√©mo
                    return {
                        version: this.currentVersion,
                        lastUpdate: new Date().toISOString(),
                        questionCount: questions ? questions.length : 0
                    };
                } catch (error) {
                    console.error('Erreur r√©cup√©ration version:', error);
                    return null;
                }
            }
            
            // Simuler un appel API pour obtenir les donn√©es
            async getData() {
                try {
                    // EN PRODUCTION : remplacer par un vrai appel API
                    // const response = await fetch(`${this.baseUrl}/questions`);
                    // return await response.json();
                    
                    // SIMULATION : retourner les donn√©es du localStorage
                    const stored = localStorage.getItem('adminquest_questions');
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.error('Erreur r√©cup√©ration donn√©es:', error);
                    return null;
                }
            }
            
            // Simuler un appel API pour uploader les nouvelles donn√©es
            async uploadData(questionsData) {
                try {
                    // EN PRODUCTION : remplacer par un vrai appel API
                    // const response = await fetch(`${this.baseUrl}/questions`, {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify(questionsData)
                    // });
                    // return await response.json();
                    
                    // SIMULATION : sauvegarder localement et incr√©menter version
                    const newVersion = (parseFloat(this.currentVersion) + 0.1).toFixed(1);
                    localStorage.setItem('adminquest_questions', JSON.stringify(questionsData));
                    this.setStoredVersion(newVersion);
                    
                    return {
                        success: true,
                        version: newVersion,
                        questionCount: questionsData.length,
                        message: 'Donn√©es mises √† jour avec succ√®s'
                    };
                } catch (error) {
                    console.error('Erreur upload:', error);
                    return { success: false, error: error.message };
                }
            }
            
            // Simuler une notification push vers tous les clients
            async notifyAllClients(message) {
                try {
                    // EN PRODUCTION : WebSocket, Server-Sent Events, ou notification push
                    // await fetch(`${this.baseUrl}/notify`, {
                    //     method: 'POST', 
                    //     body: JSON.stringify({ message })
                    // });
                    
                    // SIMULATION : d√©clencher notification locale
                    setTimeout(() => {
                        showNotification(message, 'info');
                    }, 1000);
                    
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }
        
        const serverAPI = new ServerAPI();
        
        // Fonction de synchronisation p√©riodique
        function startSyncMonitoring() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(async () => {
                const versionInfo = await serverAPI.getDataVersion();
                if (versionInfo && versionInfo.version !== lastDataVersion) {
                    console.log('Nouvelle version d√©tect√©e:', versionInfo.version);
                    await synchronizeData();
                }
            }, 30000); // V√©rifier toutes les 30 secondes
        }
        
        // Fonction de synchronisation des donn√©es
        async function synchronizeData() {
            const syncStatus = document.getElementById('syncStatus');
            
            try {
                syncStatus.className = 'sync-status updating';
                syncStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>Synchronisation...</span>';
                
                const data = await serverAPI.getData();
                if (data) {
                    questions = data;
                    lastDataVersion = await serverAPI.getDataVersion().then(v => v?.version);
                    
                    // Rafra√Æchir l'affichage
                    populateSubcategories('all');
                    filterQuestions();
                    
                    syncStatus.className = 'sync-status online';
                    syncStatus.innerHTML = '<i class="fas fa-wifi"></i> <span>Synchronis√©</span>';
                    
                    showNotification('Base de donn√©es mise √† jour !', 'success');
                }
            } catch (error) {
                console.error('Erreur synchronisation:', error);
                syncStatus.className = 'sync-status offline';
                syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Erreur sync</span>';
            }
        }
        
        // ===============================
        // INTERFACE ADMINISTRATEUR AVANC√âE
        // ===============================
        
        // Raccourci clavier Ctrl+Alt+A
        document.addEventListener('keydown', function(e) {
            const mainApp = document.getElementById('mainApp');
            if (!mainApp || mainApp.style.display === 'none') return;
            
            const isCtrlAltA = (e.ctrlKey && e.altKey && (
                e.code === 'KeyA' || e.key === 'a' || e.key === 'A' || e.keyCode === 65
            ));
            
            if (isCtrlAltA) {
                e.preventDefault();
                e.stopPropagation();
                openAdminPanel();
                return false;
            }
        });
        
        // Ouvrir le panel administrateur
        function openAdminPanel() {
            const mainApp = document.getElementById('mainApp');
            if (!mainApp || mainApp.style.display === 'none') {
                alert('üîê Acc√®s refus√©. Connectez-vous d\'abord avec un code d\'abonnement valide.');
                return;
            }
            
            // V√©rifier les droits administrateur
            const subscription = getValidSubscription();
            isAdmin = subscription && subscription.type === 'admin';
            
            updateAdminInterface();
            document.getElementById('adminOverlay').style.display = 'flex';
        }
        
        // Fermer le panel administrateur
        function closeAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'none';
        }
        
        // Mettre √† jour l'interface administrateur
        async function updateAdminInterface() {
            const versionInfo = await serverAPI.getDataVersion();
            
            document.getElementById('adminCurrentBase').textContent = 
                versionInfo ? `Version ${versionInfo.version}` : 'Non d√©finie';
            
            document.getElementById('adminLastUpdate').textContent = 
                versionInfo ? new Date(versionInfo.lastUpdate).toLocaleString('fr-FR') : '-';
            
            document.getElementById('adminQuestionCount').textContent = 
                versionInfo ? versionInfo.questionCount : questions.length;
        }
        
        // Import CSV depuis interface admin
        function importCSVAdmin() {
            if (!isAdmin) {
                showNotification('Acc√®s refus√© - Droits administrateur requis', 'warning');
                return;
            }
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            fileInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const progressBar = document.querySelector('.admin-progress-bar');
                    const progressContainer = document.getElementById('adminProgress');
                    const statusDiv = document.getElementById('adminStatus');
                    
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    statusDiv.textContent = 'Lecture du fichier CSV...';
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            progressBar.style.width = '30%';
                            statusDiv.textContent = 'Traitement des donn√©es...';
                            
                            // Traiter le CSV
                            Papa.parse(event.target.result, {
                                header: true,
                                skipEmptyLines: true,
                                complete: async function(results) {
                                    if (results.data && results.data.length > 0) {
                                        progressBar.style.width = '60%';
                                        statusDiv.textContent = 'Structuration des questions...';
                                        
                                        const processedQuestions = processCSVData(results.data);
                                        if (processedQuestions && processedQuestions.length > 0) {
                                            progressBar.style.width = '80%';
                                            statusDiv.textContent = 'Upload vers le serveur...';
                                            
                                            // Upload vers le serveur (simul√©)
                                            const uploadResult = await serverAPI.uploadData(processedQuestions);
                                            
                                            if (uploadResult.success) {
                                                progressBar.style.width = '100%';
                                                statusDiv.textContent = `‚úÖ ${uploadResult.questionCount} questions mises √† jour !`;
                                                
                                                // Mettre √† jour localement
                                                questions = processedQuestions;
                                                populateSubcategories('all');
                                                filterQuestions();
                                                
                                                // Notifier tous les utilisateurs
                                                await serverAPI.notifyAllClients(
                                                    `Base de donn√©es mise √† jour : ${uploadResult.questionCount} questions disponibles !`
                                                );
                                                
                                                updateAdminInterface();
                                                showNotification('Import r√©ussi - Tous les utilisateurs notifi√©s !', 'success');
                                                
                                                setTimeout(() => {
                                                    progressContainer.style.display = 'none';
                                                    statusDiv.textContent = '';
                                                }, 3000);
                                                
                                            } else {
                                                statusDiv.textContent = `‚ùå Erreur upload: ${uploadResult.error}`;
                                                showNotification('Erreur lors de l\'upload', 'warning');
                                            }
                                        } else {
                                            statusDiv.textContent = '‚ùå Aucune question valide dans le fichier';
                                            showNotification('Fichier CSV invalide', 'warning');
                                        }
                                    } else {
                                        statusDiv.textContent = '‚ùå Fichier CSV vide ou mal format√©';
                                        showNotification('Fichier CSV vide', 'warning');
                                    }
                                },
                                error: function(error) {
                                    statusDiv.textContent = '‚ùå Erreur traitement CSV';
                                    showNotification('Erreur de traitement', 'warning');
                                    console.error('Erreur Papa Parse:', error);
                                }
                            });
                        } catch (error) {
                            statusDiv.textContent = '‚ùå Erreur g√©n√©rale';
                            showNotification('Erreur lors de l\'import', 'warning');
                            console.error('Erreur import:', error);
                        }
                    };
                    reader.readAsText(file);
                }
                document.body.removeChild(fileInput);
            });
            
            fileInput.click();
        }
        
        // Synchroniser tous les utilisateurs
        async function syncAllUsers() {
            if (!isAdmin) {
                showNotification('Acc√®s refus√© - Droits administrateur requis', 'warning');
                return;
            }
            
            const statusDiv = document.getElementById('adminStatus');
            statusDiv.textContent = 'Synchronisation en cours...';
            
            const result = await serverAPI.notifyAllClients(
                'Synchronisation forc√©e par l\'administrateur - Rechargement des donn√©es...'
            );
            
            if (result.success) {
                statusDiv.textContent = '‚úÖ Notification envoy√©e √† tous les utilisateurs';
                showNotification('Synchronisation lanc√©e !', 'success');
                
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);
            } else {
                statusDiv.textContent = '‚ùå Erreur notification';
                showNotification('Erreur de synchronisation', 'warning');
            }
        }
        
        // Test de notification
        async function testNotification() {
            await serverAPI.notifyAllClients('Test de notification - Interface administrateur');
            showNotification('Notification test envoy√©e', 'info');
        }
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ===============================
        // CHARGEMENT ET INITIALISATION
        // ===============================
        
        function showLoadingAndInitApp() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingStatus').textContent = 'Synchronisation avec le serveur...';
            
            setTimeout(async () => {
                await loadQuestionsDatabase();
            }, 500);
        }
        
        async function loadQuestionsDatabase() {
            try {
                document.getElementById('loadingStatus').textContent = 'R√©cup√©ration des donn√©es...';
                
                // Charger depuis le serveur
                const serverData = await serverAPI.getData();
                
                if (serverData && serverData.length > 0) {
                    questions = serverData;
                    document.getElementById('loadingStatus').textContent = 
                        `${questions.length} questions synchronis√©es !`;
                } else {
                    // Fallback vers localStorage ou donn√©es d'exemple
                    const savedQuestions = localStorage.getItem('examQuestions');
                    if (savedQuestions) {
                        questions = JSON.parse(savedQuestions);
                        document.getElementById('loadingStatus').textContent = 
                            `${questions.length} questions charg√©es depuis le cache local`;
                    } else {
                        loadSampleQuestions();
                        document.getElementById('loadingStatus').textContent = 
                            'Questions d\'exemple charg√©es - En attente de synchronisation';
                    }
                }
                
                // Obtenir la version actuelle
                const versionInfo = await serverAPI.getDataVersion();
                lastDataVersion = versionInfo?.version;
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    initializeApp();
                    
                    // D√©marrer la surveillance de synchronisation
                    startSyncMonitoring();
                }, 1000);
                
            } catch (error) {
                console.error("Erreur chargement:", error);
                loadSampleQuestions();
                
                document.getElementById('loadingStatus').innerHTML = `
                    <div style="color: #e74c3c;">
                        Erreur de synchronisation<br>
                        <small>Chargement des donn√©es d'exemple...</small>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    initializeApp();
                }, 2000);
            }
        }

        // ===============================
        // APPLICATION PRINCIPALE ADMINQUEST
        // ===============================
        
        let questions = [];
        
        const subCategoryNames = {
            "1.1": "Questions de type carte blanche",
            "1.2": "Questions d'opinions citoyennes",
            "1.3": "Questions sur le caract√®re et la personnalit√©",
            "1.4": "Questions de type entretien de recrutement",
            "2.1": "Conception du management",
            "2.2": "Relation aux √©quipes",
            "2.3": "D√©fis manag√©riaux contemporains",
            "2.4": "Relation aux √©lus",
            "2.5": "Situations manag√©riales difficiles",
            "3.1": "Organisation institutionnelle et comp√©tences",
            "3.2": "Finances locales",
            "3.3": "Politiques sectorielles",
            "3.4": "Actualit√© territoriale",
            "3.5": "Europe et collectivit√©s",
            "4.1": "Relations √©lus/administration",
            "4.2": "Gestion de crise",
            "4.3": "Management d'√©quipe",
            "4.4": "D√©ontologie/√©thique professionnelle",
            "4.5": "Relation aux usagers",
            "5.1": "Questions d'opinion sensibles",
            "5.2": "Questions techniques pointues",
            "5.3": "Questions ambigu√´s",
            "5.4": "Questions pi√®ges",
            "5.5": "Questions insistantes"
        };
        
        const difficultyDescriptions = {
            1: "Connaissances fondamentales",
            2: "Analyse simple",
            3: "Analyse approfondie",
            4: "Questions pi√®ges/embarrassantes"
        };
        
        function populateSubcategories(category) {
            const subcategoryFilter = document.getElementById('subcategoryFilter');
            subcategoryFilter.innerHTML = '<option value="all">Toutes les sous-cat√©gories</option>';
            
            if (category === 'all') {
                Object.entries(subCategoryNames).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    subcategoryFilter.appendChild(option);
                });
            } else {
                Object.entries(subCategoryNames).forEach(([code, name]) => {
                    if (code.startsWith(category + '.')) {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        subcategoryFilter.appendChild(option);
                    }
                });
            }
        }
        
        function filterQuestions() {
            const categoryFilter = document.getElementById('categoryFilter');
            const subcategoryFilter = document.getElementById('subcategoryFilter');
            const difficultyFilter = document.getElementById('difficultyFilter');
            const searchInput = document.getElementById('searchInput');
            const questionsCount = document.getElementById('questionsCount');
            
            const categoryValue = categoryFilter.value;
            const subcategoryValue = subcategoryFilter.value;
            const difficultyValue = difficultyFilter.value;
            const searchValue = searchInput.value.toLowerCase();
            
            let filteredQuestions = questions.filter(question => {
                let categoryMatch = categoryValue === 'all' || question.category.toString() === categoryValue;
                let subcategoryMatch = subcategoryValue === 'all' || 
                                      `${question.category}.${question.subCategory}` === subcategoryValue;
                let difficultyMatch = difficultyValue === 'all' || question.difficulty.toString() === difficultyValue;
                let searchMatch = searchValue === '' || 
                                question.question.toLowerCase().includes(searchValue) ||
                                question.keywords.some(k => k.toLowerCase().includes(searchValue));
                
                return categoryMatch && subcategoryMatch && difficultyMatch && searchMatch;
            });
            
            displayQuestions(filteredQuestions);
            questionsCount.textContent = `Questions affich√©es : ${filteredQuestions.length} sur ${questions.length}`;
        }

        function getResponseIcon(responseType) {
            switch(responseType) {
                case 'rafale':
                    return '<i class="fas fa-bolt response-icon"></i>';
                case 'enjeux':
                    return '<i class="fas fa-feather-alt response-icon"></i>';
                case 'poisson':
                    return '<i class="fas fa-fish response-icon"></i>';
                case 'reflexive':
                    return '<i class="fas fa-brain response-icon"></i>';
                case 'theatre':
                    return '<i class="fas fa-theater-masks response-icon"></i>';
                case 'technique-longue':
                    return '<i class="fas fa-clipboard-list response-icon"></i>';
                case 'technique-courte':
                    return '<i class="fas fa-list response-icon"></i>';
                default:
                    return '<i class="fas fa-comment response-icon"></i>';
            }
        }
        
        function displayQuestions(filteredQuestions) {
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = '';
            
            if (filteredQuestions.length === 0) {
                questionList.innerHTML = '<p>Aucune question ne correspond aux crit√®res s√©lectionn√©s.</p>';
                return;
            }
            
            filteredQuestions.forEach(question => {
                const container = document.createElement('div');
                container.className = `question-container difficulty-${question.difficulty}`;
                
                const categoryNames = {
                    1: "Personnalit√©",
                    2: "Management",
                    3: "Culture territoriale",
                    4: "Mise en situation",
                    5: "Question embarrassante"
                };
                
                const categoryName = categoryNames[question.category] || "Autre";
                const subCategoryCode = `${question.category}.${question.subCategory}`;
                const subCategoryName = subCategoryNames[subCategoryCode] || "Autre";
                const difficultyDescription = difficultyDescriptions[question.difficulty] || "";
                
                const keywordsHTML = question.keywords.map(keyword => 
                    `<span class="keyword">${keyword}</span>`
                ).join('');
                
                let responseType = "";
                let labels = ["", "", "", "", ""];
                let responseTitle = "";

                if (question.responseMethod) {
                    const methodLower = question.responseMethod.toLowerCase();
                    
                    if (methodLower.includes("rafale")) {
                        responseType = "rafale";
                        responseTitle = "R√©ponse rapide et concise";
                        labels = ["D√©finition/point cl√©", "Contextualisation", "Nuance/perspective", "", ""];
                    } 
                    else if (methodLower.includes("enjeux") || methodLower.includes("albatros")) {
                        responseType = "enjeux";
                        responseTitle = "R√©ponse par les enjeux (Albatros)";
                        labels = ["Enjeu 1 + point de vue", "Enjeu 2 + point de vue", "Enjeu 3 + point de vue", "", ""];
                    } 
                    else if (methodLower.includes("poisson") || methodLower.includes("japonais")) {
                        responseType = "poisson";
                        responseTitle = "Poisson japonais";
                        labels = ["Contextualisation (t√™te)", "Premi√®re ligne d'analyse (nageoire dorsale)", "Seconde ligne d'analyse (nageoire lat√©rale)", "R√©ponse pr√©cise (collet)", "Ouverture (queue)"];
                    }
                    else if (methodLower.includes("r√©flexive") || methodLower.includes("exemple structur√©")) {
                        responseType = "reflexive";
                        responseTitle = "Analyse r√©flexive";
                        labels = ["Analyse de la situation", "Comp√©tence d√©montr√©e", "Exemple concret", "Difficult√©s rencontr√©es", "Enseignements tir√©s"];
                    }
                    else if (methodLower.includes("pi√®ce de th√©√¢tre") || methodLower.includes("3 actes")) {
                        responseType = "theatre";
                        responseTitle = "Pi√®ce de th√©√¢tre en 3 actes";
                        labels = ["Acte I: Urgence", "Acte I: Mesures imm√©diates", "Acte II: Premi√®res mesures", "Acte II: Communications", "Acte III: Solutions √† moyen terme"];
                    }
                    else if (methodLower.includes("t√©l√©graphe") || methodLower.includes("technique longue") || methodLower.includes("r√©ponse technique longue")) {
                        responseType = "technique-longue";
                        responseTitle = "R√©ponse technique longue (5 phrases)";
                        labels = ["üìã Cadre juridique", "üìä Donn√©es factuelles", "‚öôÔ∏è Enjeux op√©rationnels", "üéØ Position argument√©e", "üîÆ Prospective"];
                    }
                    else if (methodLower.includes("technique courte") || methodLower.includes("r√©ponse technique courte")) {
                        responseType = "technique-courte";
                        responseTitle = "R√©ponse technique courte (2 phrases)";
                        labels = ["üí° Point cl√©", "üìä Donn√©e essentielle", "", "", ""];
                    }
                }

                const responseIcon = getResponseIcon(responseType);

                let autoResponseHTML = "";
                const hasPhrases = question.phrase1 || question.phrase2 || question.phrase3 || question.phrase4 || question.phrase5;

                if (hasPhrases) {
                    autoResponseHTML = `<div class="auto-response ${responseType}" style="display: none;">
                    <hr>
                    ${responseIcon}
                    <h4>${responseTitle}</h4>`;
                    
                    if (question.phrase1) autoResponseHTML += `<p><strong>${labels[0]}:</strong> ${question.phrase1}</p>`;
                    if (question.phrase2) autoResponseHTML += `<p><strong>${labels[1]}:</strong> ${question.phrase2}</p>`;
                    if (responseType === "technique-longue") {
                        if (question.phrase3) autoResponseHTML += `<p><strong>${labels[2]}:</strong> ${question.phrase3}</p>`;
                        if (question.phrase4 && labels[3]) autoResponseHTML += `<p><strong>${labels[3]}:</strong> ${question.phrase4}</p>`;
                        if (question.phrase5 && labels[4]) autoResponseHTML += `<p><strong>${labels[4]}:</strong> ${question.phrase5}</p>`;
                    } else if (responseType !== "technique-courte") {
                        if (question.phrase3) autoResponseHTML += `<p><strong>${labels[2]}:</strong> ${question.phrase3}</p>`;
                        if (question.phrase4 && labels[3]) autoResponseHTML += `<p><strong>${labels[3]}:</strong> ${question.phrase4}</p>`;
                        if (question.phrase5 && labels[4]) autoResponseHTML += `<p><strong>${labels[4]}:</strong> ${question.phrase5}</p>`;
                    }
                    
                    autoResponseHTML += '</div>';
                }
                
                container.innerHTML = `
                    <div class="question">${question.id}: ${question.question}</div>
                    <div class="metadata">
                        Cat√©gorie: ${categoryName}/${subCategoryName} | 
                        Type: ${question.type} | 
                        Difficult√©: Niveau ${question.difficulty} - ${difficultyDescription}
                        ${question.responseMethod ? ` | M√©thode: ${question.responseMethod}` : ''}
                    </div>
                    <div class="attention-points">Points d'attention: ${question.attention}</div>
                    <div class="keywords">${keywordsHTML}</div>
                    ${autoResponseHTML}
                `;
                
                questionList.appendChild(container);
            });
        }
        
        function showRandomQuestion() {
            const categoryFilter = document.getElementById('categoryFilter');
            const subcategoryFilter = document.getElementById('subcategoryFilter');
            const difficultyFilter = document.getElementById('difficultyFilter');
            const searchInput = document.getElementById('searchInput');
            const questionsCount = document.getElementById('questionsCount');
            
            let categoryValue = categoryFilter.value;
            let subcategoryValue = subcategoryFilter.value;
            let difficultyValue = difficultyFilter.value;
            let searchValue = searchInput.value.toLowerCase();
            
            let filteredQuestions = questions.filter(question => {
                let categoryMatch = categoryValue === 'all' || question.category.toString() === categoryValue;
                let subcategoryMatch = subcategoryValue === 'all' || 
                                     `${question.category}.${question.subCategory}` === subcategoryValue;
                let difficultyMatch = difficultyValue === 'all' || question.difficulty.toString() === difficultyValue;
                let searchMatch = searchValue === '' || 
                               question.question.toLowerCase().includes(searchValue) ||
                               question.keywords.some(k => k.toLowerCase().includes(searchValue));
                
                return categoryMatch && subcategoryMatch && difficultyMatch && searchMatch;
            });
            
            if (filteredQuestions.length > 0) {
                const randomIndex = Math.floor(Math.random() * filteredQuestions.length);
                displayQuestions([filteredQuestions[randomIndex]]);
                questionsCount.textContent = `Question al√©atoire (1 sur ${filteredQuestions.length})`;
            } else {
                const questionList = document.getElementById('questionList');
                questionList.innerHTML = '<p>Aucune question ne correspond aux crit√®res pour s√©lection al√©atoire.</p>';
                questionsCount.textContent = 'Aucune question disponible';
            }
        }
        
        function resetFilters() {
            document.getElementById('categoryFilter').value = 'all';
            populateSubcategories('all');
            document.getElementById('difficultyFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            filterQuestions();
        }
        
        function processCSVData(csvData) {
            // M√™me fonction de traitement que dans l'original mais optimis√©e
            function mapCategory(mainCat, subCat) {
                const mainCategory = (mainCat || "").toLowerCase();
                const subCategory = (subCat || "").toLowerCase();
                
                if (mainCategory.includes("personnalit√©") || 
                    subCategory.includes("valeur") ||
                    subCategory.includes("aspiration") ||
                    subCategory.includes("caract√®re") ||
                    subCategory.includes("opinion") ||
                    subCategory.includes("personnalit√©")) {
                    return 1;
                }
                
                if (mainCategory.includes("management") || 
                    subCategory.includes("manag√©rial") ||
                    subCategory.includes("leadership") ||
                    subCategory.includes("√©quipe") ||
                    mainCategory.includes("ressources humaines") ||
                    subCategory.includes("management")) {
                    return 2;
                }
                
                if (mainCategory.includes("culture territoriale") || 
                    mainCategory.includes("juridique") ||
                    mainCategory.includes("institution") ||
                    mainCategory.includes("financi√®re") ||
                    subCategory.includes("territorial") ||
                    subCategory.includes("gouvernance")) {
                    return 3;
                }
                
                if (mainCategory.includes("mise en situation") || 
                    subCategory.includes("crise") ||
                    (subCategory.includes("relation") && subCategory.includes("√©lu"))) {
                    return 4;
                }
                
                return 5;
            }
            
            function mapSubCategory(categoryId, mainCat, subCat) {
                const mainCategory = (mainCat || "").toLowerCase();
                const subCategory = (subCat || "").toLowerCase();
                
                if (categoryId === 1) {
                    if (subCategory.includes("carte blanche") || 
                        subCategory.includes("aspiration") ||
                        subCategory.includes("id√©al")) {
                        return 1;
                    }
                    if (subCategory.includes("citoyen") || 
                        subCategory.includes("opinion") ||
                        subCategory.includes("soci√©t√©")) {
                        return 2;
                    }
                    if (subCategory.includes("caract√®re") || 
                        subCategory.includes("personnalit√©") ||
                        subCategory.includes("analyse de soi")) {
                        return 3;
                    }
                    return 4;
                }
                
                if (categoryId === 2) {
                    if (subCategory.includes("concept") || 
                        subCategory.includes("vision") ||
                        subCategory.includes("th√©orie")) {
                        return 1;
                    }
                    if (subCategory.includes("√©quipe") || 
                        subCategory.includes("relation") ||
                        subCategory.includes("collaboration")) {
                        return 2;
                    }
                    if (subCategory.includes("contemporain") || 
                        subCategory.includes("d√©fi") ||
                        subCategory.includes("num√©rique") ||
                        subCategory.includes("diversit√©")) {
                        return 3;
                    }
                    if (subCategory.includes("√©lu") || 
                        subCategory.includes("politique")) {
                        return 4;
                    }
                    return 5;
                }
                
                if (categoryId === 3) {
                    if (subCategory.includes("institution") || 
                        subCategory.includes("organisation") ||
                        subCategory.includes("comp√©tence")) {
                        return 1;
                    }
                    if (subCategory.includes("finance") || 
                        subCategory.includes("budget") ||
                        subCategory.includes("fiscal")) {
                        return 2;
                    }
                    if (subCategory.includes("sectoriel") || 
                        subCategory.includes("social") ||
                        subCategory.includes("√©ducation") ||
                        subCategory.includes("environnement")) {
                        return 3;
                    }
                    if (subCategory.includes("actualit√©")) {
                        return 4;
                    }
                    return 5;
                }
                
                if (categoryId === 4) {
                    if (subCategory.includes("√©lu") || 
                        subCategory.includes("politique")) {
                        return 1;
                    }
                    if (subCategory.includes("crise")) {
                        return 2;
                    }
                    if (subCategory.includes("√©quipe") || 
                        subCategory.includes("management d'√©quipe")) {
                        return 3;
                    }
                    if (subCategory.includes("√©thique") || 
                        subCategory.includes("d√©ontologie")) {
                        return 4;
                    }
                    return 5;
                }
                
                if (categoryId === 5) {
                    if (subCategory.includes("sensible") || 
                        subCategory.includes("controvers")) {
                        return 1;
                    }
                    if (subCategory.includes("technique") || 
                        subCategory.includes("pointu") ||
                        subCategory.includes("juridique")) {
                        return 2;
                    }
                    if (subCategory.includes("ambigu")) {
                        return 3;
                    }
                    if (subCategory.includes("pi√®ge")) {
                        return 4;
                    }
                    return 5;
                }
                
                return 1;
            }
            
            function normalizeDifficulty(level) {
                if (level === null || level === undefined) return 2;
                
                if (typeof level === 'string') {
                    if (level.includes("Niveau")) {
                        const num = parseInt(level.replace("Niveau ", ""));
                        return Math.min(Math.max(1, num), 4);
                    }
                }
                
                if (typeof level === 'number') {
                    return Math.min(Math.max(1, level), 4);
                }
                
                return 2;
            }
            
            const structuredQuestions = csvData.map((item, index) => {
                if (!item.Question) return null;
                
                const mainCategory = mapCategory(item["Cat√©gorie principale"], item["Sous-cat√©gorie"]);
                const subCategory = mapSubCategory(mainCategory, item["Cat√©gorie principale"], item["Sous-cat√©gorie"]);
                const difficulty = normalizeDifficulty(item["Niveau de difficult√©"]);
                
                let type = "Opinion";
                if (item.Question.toLowerCase().includes("que faites-vous") || 
                    item.Question.toLowerCase().includes("comment g√©rez-vous") ||
                    mainCategory === 4) {
                    type = "Mise en situation";
                } else if (item.Question.toLowerCase().includes("qu'est-ce que") || 
                          item.Question.toLowerCase().includes("d√©finissez")) {
                    type = "Factuelle";
                }
                
                const keywords = item["Mots-cl√©s"] ? 
                                item["Mots-cl√©s"].split(",").map(k => k.trim()) : 
                                [];
                
                return {
                    id: item["ID"] || `Q${index+1}`,
                    question: item.Question,
                    category: mainCategory,
                    subCategory: subCategory,
                    difficulty: difficulty,
                    type: type,
                    keywords: keywords,
                    attention: item["Points d'attention (√©l√©ments clefs √† consid√©rer)"] || 
                              "Pr√©parez une r√©ponse structur√©e qui d√©montre votre compr√©hension des enjeux.",
                    responseMethod: item["M√©thode de r√©ponse recommand√©e"] || "",
                    phrase1: item["phrase 1"] || "",
                    phrase2: item["phrase 2"] || "",
                    phrase3: item["phrase 3"] || "",
                    phrase4: item["phrase 4"] || "",
                    phrase5: item["phrase 5"] || "",
                    epreuve: item["√âpreuve "] || item["√âpreuve"] || item["epreuve"] || "ENTRETIEN",                   
                    motsClesTransversaux: item["Mots-cl√©s-transversaux"] || ""                     
                };
            }).filter(q => q !== null);
            
            return structuredQuestions;
        }
        
        function loadSampleQuestions() {
            questions = [
                {
                    id: "Q1",
                    question: "Comment d√©finiriez-vous le r√¥le du manager territorial ?",
                    category: 2,
                    subCategory: 1,
                    difficulty: 2,
                    type: "Opinion",
                    keywords: ["management", "service public", "leadership"],
                    attention: "Montre votre vision du management public. Int√©grer la dimension politique et la sp√©cificit√© du service public.",
                    responseMethod: "Par les enjeux",
                    epreuve: "ENTRETIEN",
                    phrase1: "",
                    phrase2: "",
                    phrase3: "",
                    phrase4: "",
                    phrase5: ""
                },
                {
                    id: "Q2",
                    question: "La diff√©renciation territoriale est-elle compatible avec l'√©galit√© r√©publicaine ?",
                    category: 3,
                    subCategory: 1,
                    difficulty: 3,
                    type: "Opinion",
                    keywords: ["diff√©renciation", "√©galit√©", "constitution", "adaptation"],
                    attention: "Question au c≈ìur des d√©bats actuels sur l'organisation territoriale. Montrer sa connaissance de la loi 3DS.",
                    responseMethod: "Poisson japonais",
                    epreuve: "ENTRETIEN",
                    phrase1: "",
                    phrase2: "",
                    phrase3: "",
                    phrase4: "",
                    phrase5: ""
                },
                {
                    id: "DEMO",
                    question: "üîÑ Version centralis√©e - En attente de synchronisation avec le serveur",
                    category: 1,
                    subCategory: 1,
                    difficulty: 1,
                    type: "Demo",
                    keywords: ["demo", "sync"],
                    attention: "Cette question de d√©monstration appara√Æt en attendant la synchronisation avec les donn√©es centralis√©es.",
                    responseMethod: "Information",
                    epreuve: "ENTRETIEN",
                    phrase1: "",
                    phrase2: "",
                    phrase3: "",
                    phrase4: "",
                    phrase5: ""
                }
            ];
            
            filterQuestions();
        }
        
        function initAutoResponseToggle() {
            const toggleSwitch = document.getElementById('autoToggleSwitch');
            const toggleStatus = document.getElementById('autoToggleStatus');
            const checkbox = document.getElementById('showAutoResponses');
            
            function updateToggleState(isActive) {
                if (isActive) {
                    toggleSwitch.classList.add('active');
                    toggleStatus.textContent = 'Visibles';
                    toggleStatus.classList.add('active');
                } else {
                    toggleSwitch.classList.remove('active');
                    toggleStatus.textContent = 'Masqu√©es';
                    toggleStatus.classList.remove('active');
                }
                
                toggleSwitch.classList.add('pulse');
                setTimeout(() => {
                    toggleSwitch.classList.remove('pulse');
                }, 300);
            }
            
            toggleSwitch.addEventListener('click', function() {
                checkbox.checked = !checkbox.checked;
                updateToggleState(checkbox.checked);
                
                const autoResponses = document.querySelectorAll('.auto-response');
                autoResponses.forEach(response => {
                    response.style.display = checkbox.checked ? 'block' : 'none';
                });
            });
            
            const toggleLabel = document.querySelector('.toggle-label');
            toggleLabel.addEventListener('click', function() {
                toggleSwitch.click();
            });
            
            checkbox.addEventListener('change', function() {
                updateToggleState(this.checked);
                
                const autoResponses = document.querySelectorAll('.auto-response');
                autoResponses.forEach(response => {
                    response.style.display = this.checked ? 'block' : 'none';
                });
            });
        }
        
        function initializeApp() {
            populateSubcategories('all');
            filterQuestions();
            initAutoResponseToggle();
            
            // √âv√©nements
            document.getElementById('categoryFilter').addEventListener('change', function() {
                populateSubcategories(this.value);
                filterQuestions();
            });
            
            document.getElementById('subcategoryFilter').addEventListener('change', filterQuestions);
            document.getElementById('difficultyFilter').addEventListener('change', filterQuestions);
            document.getElementById('searchInput').addEventListener('input', filterQuestions);
            document.getElementById('randomButton').addEventListener('click', showRandomQuestion);
            document.getElementById('resetButton').addEventListener('click', resetFilters);
        }
        
        // ===============================
        // INITIALISATION AU CHARGEMENT
        // ===============================
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Admin\'Quest - Architecture centralis√©e avec import administrateur');
            
            const subscriptionCodeInput = document.getElementById('subscriptionCode');
            if (subscriptionCodeInput) {
                subscriptionCodeInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        validateSubscription();
                    }
                });
            }
            
            const subscription = getValidSubscription();
            if (subscription) {
                document.getElementById('subscriptionOverlay').style.display = 'none';
                showLoadingAndInitApp();
            }
        });
    </script>
</body>
</html>